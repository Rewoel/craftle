<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft Craftle: T√§gliche Herausforderung</title>
    <!-- AKTUALISIERT: Verwendet jetzt die vom Benutzer bereitgestellte Favicon-Datei. -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <style>
        /* --- Minecraft UI Basis Styling --- */
        body {
            font-family: 'Press Start 2P', 'Inter', sans-serif;
            background-color: #3c3c3c; 
            color: #1f1f1f; 
            display: flex;
            flex-direction: column; 
            align-items: center; 
            padding: 20px;
        }
        .container {
            max-width: 600px;
            width: 100%;
        }

        /* Styling f√ºr das Titelbild */
        .game-title-image {
            max-width: 100%; 
            height: auto; 
            display: block; 
            margin-bottom: 30px; 
            image-rendering: pixelated; 
            width: 512px; 
            height: 112px; 
            object-fit: contain; 
        }

        /* The Main Card (Inventory/Crafting Table Window) */
        .mc-window {
            background-color: #c6c6c6; 
            border: 2px solid #000;
            box-shadow: 2px 2px 0 0 #555, -2px -2px 0 0 #fff; 
            padding: 6px; 
            border-radius: 0; 
            position: relative;
        }

        /* --- Slot Styling (50x50) --- */
        .mc-slot {
            background-color: #8b8b8b; 
            width: 50px; 
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            border-radius: 0;
            user-select: none;
            transition: none;
            
            /* Sunken/Inner Border Effect */
            border: 1px solid transparent;
            box-shadow: 1px 1px 0 0 #000, -1px -1px 0 0 #fff;
            position: relative; 
            overflow: hidden;
        }
        
        .mc-slot img {
            width: 80%; 
            height: 80%;
            object-fit: contain;
            image-rendering: pixelated; 
            z-index: 10;
        }

        .mc-slot.empty {
            background-color: #8b8b8b;
        }

        /* --- Grid and Layout --- */
        .mc-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0px;
            width: 156px; 
            aspect-ratio: 1 / 1;
            padding: 1px;
        }

        /* --- STYLES F√úR DEN PFEIL-BEREICH (JETZT KLEINER) --- */
        .mc-arrow-container {
            display: flex;
            align-items: center; 
            justify-content: center;
            padding: 0 5px; 
        }
        .crafting-arrow-img {
            width: 75px; 
            height: 75px; 
            object-fit: contain;
            image-rendering: pixelated;
            display: block;
        }

        /* --- Feedback Colors --- */
        .feedback-green {
            background-color: #00aa00 !important; 
            box-shadow: 1px 1px 0 0 #005500, -1px -1px 0 0 #55ff55 !important;
        }
        .feedback-yellow {
            background-color: #ffaa00 !important; 
            box-shadow: 1px 1px 0 0 #aa5500, -1px -1px 0 0 #ffff55 !important;
        }
        .feedback-gray {
            background-color: #555555 !important; 
            box-shadow: 1px 1px 0 0 #000000, -1px -1px 0 0 #8b8b8b !important;
        }

        /* --- Material Picker (Inventory) --- */
        .mc-inventory-grid {
            grid-template-columns: repeat(auto-fit, minmax(50px, 1fr));
            gap: 4px;
            padding-top: 8px;
        }
        .material-button {
            padding: 0;
            box-shadow: none;
            height: 50px;
            width: 100%;
        }
        .material-active {
            box-shadow: inset 1px 1px 0 0 #000, inset -1px -1px 0 0 #fff;
            outline: none;
            background-color: #c6c6c6; 
        }
        .mc-slot.material-empty {
            background-color: #555555;
            color: #c6c6c6;
            font-size: 0.5rem; 
        }

        /* --- General UI Elements --- */
        .mc-title {
            font-size: 1rem;
            font-weight: bold;
            color: #3f3f3f;
            text-shadow: 1px 1px 0 #fff;
            padding-left: 5px;
            margin-bottom: 5px;
            font-size: 0.6rem; 
        }
        .mc-button {
            border: 2px solid #000;
            background-color: #8b8b8b;
            box-shadow: 1px 1px 0 0 #555, -1px -1px 0 0 #fff;
            color: #1f1f1f;
            font-weight: bold;
            padding: 8px;
            text-shadow: 1px 1px 0 #fff;
            image-rendering: pixelated;
            font-size: 0.6rem; 
        }
        .mc-button:hover:not(:disabled) {
            background-color: #9c9c9c;
        }
        .mc-button:active:not(:disabled) {
            box-shadow: inset 1px 1px 0 0 #000, inset -1px -1px 0 0 #fff;
            padding-top: 9px;
            padding-bottom: 7px;
        }
        .mc-button:disabled {
            background-color: #555555;
            color: #8b8b8b;
            cursor: not-allowed;
            text-shadow: none;
        }
        #targetItemName {
            font-size: 0.8rem; 
        }
        #instructions h2 {
            font-size: 0.7rem;
        }
        #instructions ul {
            font-size: 0.55rem;
        }
        #loadingOverlay {
            background-color: rgba(60, 60, 60, 0.9);
            color: #fff;
            font-size: 1rem;
            padding: 20px;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <img src="titel.png" alt="Minecraft Craftle" class="game-title-image" width="512" height="112">

    <div class="container">
        <div id="loadingOverlay" class="mc-window text-center mb-4">
            Lade Spiel und verbinde mit Firebase...
        </div>

        <div id="gameContainer" class="mc-window shadow-2xl hidden">
            
            <div class="mc-title mb-2 text-center text-base text-gray-700" id="modeTitle">
                ‚Äî Craftle wird geladen ‚Äî
            </div>

            <div class="mc-title mb-4 text-center">
                <span class="text-base text-gray-700">CRAFTING F√úR:</span> 
                <span id="targetItemName" class="font-bold text-xl text-orange-700">???</span>
            </div>

            <div class="flex items-start justify-center mb-6" style="align-items: center;">
                <div id="currentGuessGrid" class="mc-grid">
                    <!-- Crafting Grid -->
                </div>

                <div class="mc-arrow-container">
                    <img id="craftingArrow" src="Pfeil.png" alt="Crafting Arrow" class="crafting-arrow-img">
                </div>

                <div id="resultSlot" class="mc-slot">
                    <span id="resultContent" class="text-xl font-bold text-gray-400">?</span>
                </div>
            </div>

            <div class="mc-title mt-4">MATERIALIEN (INVENTORY)</div>
            <div id="materialPicker" class="grid mc-inventory-grid">
                <!-- Material Picker -->
            </div>

            <div class="flex flex-col space-y-4 mt-6">
                <button id="submitButton" class="mc-button text-lg" disabled>
                    REZEPT PR√úFEN (0/6)
                </button>
            </div>
            
            <div class="mc-title mt-6 text-xl">BISHERIGE VERSUCHE:</div>
            <div id="attemptsContainer" class="space-y-3 p-2 border border-gray-500 rounded-sm">
                <!-- Attempt History -->
            </div>

            <!-- GE√ÑNDERTE KLASSEN F√úR ZENTRIERUNG -->
            <div class="flex space-x-2 mt-4 justify-center">
                <button id="randomGameButton" class="mc-button">
                    ZUF√ÑLLIGES SPIEL STARTEN
                </button>
                <button id="dailyGameButton" class="mc-button hidden">
                    ZUM T√ÑGLICHEN CRAFTLE
                </button>
            </div>

        </div> 
        
        <div id="instructions" class="bg-gray-700 p-4 rounded-lg shadow-xl mt-6 text-white">
            <h2 class="font-bold mb-2">ANLEITUNG</h2>
            <ul class="list-disc list-inside space-y-1">
                <li>W√ÑHLE UNTEN EIN MATERIAL (ODER "LEER") AUS UND PLATZIERE ES IN DAS 3X3-GITTER.</li>
                <li>DU KANNST EIN REZEPT PR√úFEN, SOBALD DU **MINDESTENS EIN MATERIAL** PLATZIERT HAST.</li>
                <li>**FEEDBACK**: GR√úN = MATERIAL & POSITION RICHTIG. GELB = MATERIAL RICHTIG, POSITION FALSCH. GRAU = MATERIAL NICHT IM REZEPT.</li>
            </ul>
        </div>

    </div>

    <!-- MODAL F√úR SPIELENDE -->
    <div id="modalOverlay" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div id="modalContent" class="mc-window p-8 w-11/12 max-w-md text-center border-4 border-black">
            <h3 id="modalTitle" class="text-3xl font-bold mb-4 text-orange-700 text-shadow-lg"></h3>
            <p id="modalMessage" class="mb-6 text-lg"></p>
            <div class="bg-gray-400 p-3 mb-6 border border-gray-500">
                <p class="text-sm font-semibold mb-2">DAS KORREKTE REZEPT F√úR: <span id="modalTargetName" class="font-bold"></span></p>
                <div id="correctRecipeDisplay" class="mc-grid mx-auto max-w-[156px]"></div>
            </div>
            <button id="modalRestartButton" class="mc-button py-2 px-6">
                NEUES SPIEL STARTEN
            </button>
        </div>
    </div>


    <script type="module">
        // Importe f√ºr Firebase SDK v12.5.0
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
        
        // --- üîí FIREBASE KONFIGURATION üîí ---
        // Dies ist die von Ihnen bereitgestellte Konfiguration.
        const YOUR_FIREBASE_CONFIG = {
            apiKey: "AIzaSyADgBthcev7lz4GpgqpUMfD5ehNAJXvHXE",
            authDomain: "craftle-ce3ce.firebaseapp.com",
            projectId: "craftle-ce3ce",
            storageBucket: "craftle-ce3ce.firebasestorage.app",
            messagingSenderId: "949644251377",
            appId: "1:949644251377:web:cb150ef2ea7a4ab1ac1950",
            measurementId: "G-QJS81B2GC1"
        };
        // ------------------------------------

        // Konstanten
        const MAX_ATTEMPTS = 6;
        const CRAFTLE_APP_ID = YOUR_FIREBASE_CONFIG.projectId; // Verwende die Project ID als eindeutige App ID

        // Globale Variablen
        let gameState = {};
        let craftSound;
        let app, db, auth;
        let userId = null; 
        
        // --- Material- und Rezepte-Daten (unver√§ndert) ---
        const materialMap = {
            'E': { name: 'Leer', fileName: 'Leer.png', size: '160x160', mcColor: '#8b8b8b' },
            'W': { name: 'Holz', fileName: 'Eichenholzbretter.png', size: '300x300', mcColor: '#a0522d' },
            'C': { name: 'Stein', fileName: 'Bruchstein.png', size: '300x300', mcColor: '#808080' },
            'I': { name: 'Eisen', fileName: 'Eisenbarren.png', size: '160x160', mcColor: '#c0c0c0' },
            'S': { name: 'Stock', fileName: 'Stock.png', size: '160x160', mcColor: '#7a5230' },
            'D': { name: 'Dia', fileName: 'Diamant.png', size: '160x160', mcColor: '#6afb92' },
            'G': { name: 'Gold', fileName: 'Goldbarren.png', size: '160x160', mcColor: '#ffd700' },
        };

        const recipes = [
            { item: 'Holzspitzhacke', recipe: ['W', 'W', 'W', 'E', 'S', 'E', 'E', 'S', 'E'] },
            { item: 'Truhe', recipe: ['W', 'W', 'W', 'W', 'E', 'W', 'W', 'W', 'W'] },
            { item: 'Ofen', recipe: ['C', 'C', 'C', 'C', 'E', 'C', 'C', 'C', 'C'] },
            { item: 'Fackel', recipe: ['E', 'E', 'E', 'E', 'C', 'E', 'E', 'S', 'E'] }, 
            { item: 'Eisenhelm', recipe: ['I', 'I', 'I', 'I', 'E', 'I', 'E', 'E', 'E'] },
            { item: 'Schwert', recipe: ['E', 'I', 'E', 'E', 'I', 'E', 'E', 'S', 'E'] },
            { item: 'Eimer', recipe: ['I', 'E', 'I', 'E', 'I', 'E', 'E', 'E', 'E'] },
            { item: 'Diamantblock', recipe: ['D', 'D', 'D', 'D', 'D', 'D', 'D', 'D', 'D'] },
        ];


        // --- DOM-Elemente ---
        const targetItemNameEl = document.getElementById('targetItemName');
        const currentGuessGridEl = document.getElementById('currentGuessGrid');
        const materialPickerEl = document.getElementById('materialPicker');
        const submitButton = document.getElementById('submitButton');
        const attemptsContainerEl = document.getElementById('attemptsContainer');
        const randomGameButton = document.getElementById('randomGameButton');
        const dailyGameButton = document.getElementById('dailyGameButton');
        const modalOverlay = document.getElementById('modalOverlay');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalTargetName = document.getElementById('modalTargetName');
        const correctRecipeDisplay = document.getElementById('correctRecipeDisplay');
        const modeTitleEl = document.getElementById('modeTitle');
        const loadingOverlayEl = document.getElementById('loadingOverlay');
        const gameContainerEl = document.getElementById('gameContainer');
        const modalRestartButton = document.getElementById('modalRestartButton');

        
        // --- Firebase Initialisierung und Auth ---

        async function initFirebaseAndAuth() {
            try {
                if (!YOUR_FIREBASE_CONFIG.projectId) {
                    throw new Error("Firebase Konfiguration fehlt.");
                }

                app = initializeApp(YOUR_FIREBASE_CONFIG);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Anonyme Anmeldung f√ºr jeden Besucher
                const userCredential = await signInAnonymously(auth);
                userId = userCredential.user.uid;

                console.log("Firebase initialized. User ID:", userId);
                
                loadingOverlayEl.classList.add('hidden');
                gameContainerEl.classList.remove('hidden');

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                loadingOverlayEl.textContent = 'Fehler beim Laden (DB-Verbindung fehlgeschlagen). Starte zuf√§lliges Spiel.';
                
                // Fallback: Starte zuf√§lliges Spiel ohne DB
                await new Promise(resolve => setTimeout(resolve, 2000));
                loadingOverlayEl.classList.add('hidden');
                gameContainerEl.classList.remove('hidden');
                startCraftle('random');
                return;
            }

            // Starte das Spiel im Daily-Modus, nachdem Firebase bereit ist
            startCraftle('daily');
        }

        // --- Firebase Lese- und Schreibfunktionen ---
        
        function getDateString() {
            // Holt das aktuelle Datum im Format YYYY-MM-DD
            return new Date().toISOString().split('T')[0];
        }

        async function getDailyRecipeIndex() {
            const dateString = getDateString();
            // Pfad: /artifacts/{CRAFTLE_APP_ID}/public/data/daily_craftles/{YYYY-MM-DD}
            const docRef = doc(db, `artifacts/${CRAFTLE_APP_ID}/public/data/daily_craftles`, dateString);

            try {
                // 1. Leseversuch
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    return docSnap.data().recipeIndex;
                } else {
                    // 2. Erstelle ein neues t√§gliches Rezept, wenn es noch nicht existiert
                    const randomIndex = Math.floor(Math.random() * recipes.length);
                    
                    // 3. Speichern des neuen t√§glichen Rezepts
                    if(userId) {
                         await setDoc(docRef, { 
                            recipeIndex: randomIndex, 
                            timestamp: serverTimestamp()
                        }, { merge: true });
                    }
                   
                    return randomIndex;
                }
            } catch (error) {
                console.error("Error accessing/creating daily recipe in DB:", error);
                // Zus√§tzliche Warnung zur Behebung des Permission-Fehlers
                console.warn("FEHLER: Die Firestore-Sicherheitsregeln erlauben das Schreiben des TAGES-REZEPTS m√∂glicherweise nicht. Bitte √ºberpr√ºfen Sie die Regeln f√ºr den Pfad: /artifacts/{appId}/public/data/daily_craftles/{date}");
                
                // Fallback auf zuf√§lliges Rezept, wenn DB-Zugriff fehlschl√§gt
                return Math.floor(Math.random() * recipes.length);
            }
        }
        
        async function saveDailyAttempts(attempts, won) {
            if (!userId) return; 
            
            const dateString = getDateString();
            // Pfad: /artifacts/{CRAFTLE_APP_ID}/users/{userId}/daily_progress/{YYYY-MM-DD}
            const docRef = doc(db, `artifacts/${CRAFTLE_APP_ID}/users/${userId}/daily_progress`, dateString);

            try {
                // Wir speichern den gesamten Fortschritt, um ihn sp√§ter wiederherzustellen
                await setDoc(docRef, {
                    attempts: JSON.stringify(attempts), // Arrays werden als JSON String gespeichert
                    won: won,
                    timestamp: serverTimestamp()
                }, { merge: true });
            } catch (error) {
                console.error("Error saving daily progress:", error);
                // Zus√§tzliche Warnung zur Behebung des Permission-Fehlers
                console.warn("FEHLER: Die Firestore-Sicherheitsregeln erlauben das Speichern des FORTSCHRITTS m√∂glicherweise nicht. Bitte √ºberpr√ºfen Sie die Regeln f√ºr den Pfad: /artifacts/{appId}/users/{userId}/daily_progress/{date}");
            }
        }
        
        async function loadDailyProgress() {
            if (!userId) return null;
            
            const dateString = getDateString();
            const docRef = doc(db, `artifacts/${CRAFTLE_APP_ID}/users/${userId}/daily_progress`, dateString);
            
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // Stelle sicher, dass 'attempts' existiert und geparst werden kann
                    return {
                        attempts: data.attempts ? JSON.parse(data.attempts) : [],
                        won: data.won || false
                    };
                }
            } catch (error) {
                console.warn("Could not load daily progress, starting fresh (Check your Firestore Rules if this persists):", error);
            }
            return null;
        }

        // --- Initialisierung des Spiels (Mode-abh√§ngig) ---
        async function startCraftle(mode = 'daily') {
            let target;
            let initialAttempts = [];
            let initialWon = false;
            
            if (mode === 'daily') {
                modeTitleEl.textContent = '‚Äî DAS CRAFTLE DES TAGES ‚Äî';
                const targetIndex = await getDailyRecipeIndex();
                target = recipes[targetIndex];
                
                // Lade den gespeicherten Fortschritt
                const progress = await loadDailyProgress();
                if (progress) {
                    initialAttempts = progress.attempts;
                    initialWon = progress.won;
                    if (initialWon || initialAttempts.length >= MAX_ATTEMPTS) {
                        // Spiel ist bereits beendet
                        gameState.targetRecipe = target.recipe;
                        gameState.targetItem = target.item;
                        gameState.attempts = initialAttempts;
                        gameState.attemptCount = initialAttempts.length;
                        endGame(initialWon); 
                        
                        randomGameButton.classList.remove('hidden');
                        dailyGameButton.classList.add('hidden');
                        return; // WICHTIG: Das Spiel nicht zur√ºcksetzen, wenn es bereits beendet ist.
                    }
                }
                
                randomGameButton.classList.remove('hidden');
                dailyGameButton.classList.add('hidden');
                
            } else {
                modeTitleEl.textContent = '‚Äî ZUF√ÑLLIGES SPIEL ‚Äî';
                const randomIndex = Math.floor(Math.random() * recipes.length);
                target = recipes[randomIndex];
                randomGameButton.classList.add('hidden');
                dailyGameButton.classList.remove('hidden');
            }

            // Gemeinsame Initialisierung
            gameState = {
                targetRecipe: target.recipe,
                targetItem: target.item,
                currentGuess: Array(9).fill('E'),
                attempts: initialAttempts,
                attemptCount: initialAttempts.length,
                gameOver: false,
                selectedMaterial: 'W', 
                mode: mode,
            };

            targetItemNameEl.textContent = '???'; 
            submitButton.textContent = `REZEPT PR√úFEN (${gameState.attemptCount}/${MAX_ATTEMPTS})`;
            submitButton.disabled = gameState.gameOver;
            attemptsContainerEl.innerHTML = '';
            modalOverlay.classList.add('hidden');
            
            // Render vorherige Versuche (f√ºr Daily Craftle)
            gameState.attempts.forEach(attempt => {
                renderAttempt(attempt.guess, attempt.feedback, true); // true = no animation
            });

            renderCurrentGuessGrid();
            renderMaterialPicker();
            updateSubmitButtonState();
        }

        // --- Hilfsfunktionen (unver√§ndert) ---
        function getMaterialImageUrl(materialId) {
            const material = materialMap[materialId];
            if (materialId === 'E') return ''; 
            const [width, height] = material.size.split('x');
            const color = material.mcColor.replace('#', '');
            const textColor = 'ffffff'; 
            return `https://placehold.co/${width}x${height}/${color}/${textColor}?text=${material.name.substring(0,3)}`;
        }

        function createMaterialImageElement(materialId) {
            const material = materialMap[materialId];
            const img = document.createElement('img');
            img.src = material.fileName;
            img.alt = material.name;
            
            img.onerror = function() {
                this.src = getMaterialImageUrl(materialId);
                this.onerror = null; 
            };
            
            img.classList.add('transition', 'duration-100', 'ease-out');
            return img;
        }


        // --- Rendering Funktionen ---

        function renderCurrentGuessGrid() {
            currentGuessGridEl.innerHTML = '';
            gameState.currentGuess.forEach((materialId, index) => {
                const slot = document.createElement('div');
                slot.className = `mc-slot`;
                slot.id = `slot-${index}`;
                
                if (materialId !== 'E') {
                    const img = createMaterialImageElement(materialId);
                    slot.appendChild(img);
                } else {
                    slot.classList.add('empty');
                }

                slot.addEventListener('click', () => handleSlotClick(index));
                currentGuessGridEl.appendChild(slot);
            });
        }


        function renderMaterialPicker() {
            materialPickerEl.innerHTML = '';
            const availableMaterials = Object.keys(materialMap);

            availableMaterials.forEach(id => {
                const material = materialMap[id];
                const button = document.createElement('button');
                
                if (id === 'E') {
                    button.className = `mc-slot material-button material-empty font-semibold ${gameState.selectedMaterial === id ? 'material-active' : ''}`;
                    button.textContent = 'LEER';
                } else {
                    button.className = `mc-slot material-button font-semibold ${gameState.selectedMaterial === id ? 'material-active' : ''}`;
                    const img = createMaterialImageElement(id);
                    button.appendChild(img);
                }

                button.setAttribute('data-material-id', id);

                button.addEventListener('click', () => {
                    gameState.selectedMaterial = id;
                    renderMaterialPicker(); 
                });
                materialPickerEl.appendChild(button);
            });
        }

        function renderAttempt(guess, feedback, noAnimation = false) {
            const attemptDiv = document.createElement('div');
            attemptDiv.className = 'flex flex-col p-2 bg-gray-500/50 rounded-sm feedback-grid';

            const feedbackGrid = document.createElement('div');
            feedbackGrid.className = 'mc-grid mx-auto';

            guess.forEach((materialId, index) => {
                const fb = feedback[index];
                const slot = document.createElement('div');
                
                slot.className = `mc-slot ${fb.color}`; 
                
                if (materialId !== 'E') {
                    const img = createMaterialImageElement(materialId);
                    slot.appendChild(img);
                } else {
                    slot.classList.add('empty');
                }
                
                if (!noAnimation) {
                    slot.style.animationDelay = `${index * 0.05}s`;
                }

                feedbackGrid.appendChild(slot);
            });

            attemptDiv.appendChild(feedbackGrid);
            attemptsContainerEl.prepend(attemptDiv);
        }

        function renderCorrectRecipe(recipe, containerEl) {
            containerEl.innerHTML = '';
            recipe.forEach(materialId => {
                const slot = document.createElement('div');
                slot.className = `mc-slot`;
                
                if (materialId !== 'E') {
                    const img = createMaterialImageElement(materialId);
                    slot.appendChild(img);
                    slot.style.boxShadow = `1px 1px 0 0 #fff, -1px -1px 0 0 #000`; 
                } else {
                    slot.classList.add('empty');
                }

                containerEl.appendChild(slot);
            });
        }

        // --- Event Handler und Logik ---

        function handleSlotClick(index) {
            if (gameState.gameOver) return;

            const currentMaterial = gameState.currentGuess[index];

            if (currentMaterial === gameState.selectedMaterial) {
                gameState.currentGuess[index] = 'E';
            } else {
                gameState.currentGuess[index] = gameState.selectedMaterial;
            }

            renderCurrentGuessGrid();
            updateSubmitButtonState();
        }

        function updateSubmitButtonState() {
            const isAnyMaterialPlaced = gameState.currentGuess.some(id => id !== 'E');
            submitButton.disabled = !isAnyMaterialPlaced || gameState.gameOver;
            submitButton.textContent = `REZEPT PR√úFEN (${gameState.attemptCount}/${MAX_ATTEMPTS})`;
        }

        submitButton.addEventListener('click', checkRecipe);
        randomGameButton.addEventListener('click', () => startCraftle('random'));
        dailyGameButton.addEventListener('click', () => startCraftle('daily'));
        
        // BUG FIX: Nach Spielende (auch Daily) soll der Restart-Button immer ein frisches ZUF√ÑLLIGES Spiel starten.
        modalRestartButton.addEventListener('click', () => {
             startCraftle('random');
        });


        function checkRecipe() {
            if (gameState.gameOver || submitButton.disabled) return;

            const guess = [...gameState.currentGuess];
            const target = [...gameState.targetRecipe];
            const feedback = Array(9).fill(null);
            
            // 1. GR√úN (Perfekter Treffer) pr√ºfen
            let correctCount = 0;
            for (let i = 0; i < 9; i++) {
                if (guess[i] === target[i]) { 
                    feedback[i] = { color: 'feedback-green', id: guess[i] };
                    correctCount++;
                    guess[i] = null; 
                    target[i] = null;
                }
            }
            
            // 2. GELB (Material im Rezept, aber falsche Position) pr√ºfen
            const targetCounts = {};
            for (let i = 0; i < 9; i++) {
                if (target[i] !== null && target[i] !== 'E') {
                    targetCounts[target[i]] = (targetCounts[target[i]] || 0) + 1;
                }
            }
            
            for (let i = 0; i < 9; i++) {
                if (feedback[i] === null && guess[i] !== null) {
                    const materialId = guess[i];
                    
                    if (materialId !== 'E' && targetCounts[materialId] > 0) {
                        feedback[i] = { color: 'feedback-yellow', id: materialId };
                        targetCounts[materialId]--;
                    } else {
                        feedback[i] = { color: 'feedback-gray', id: materialId };
                    }
                }
            }

            gameState.attempts.push({ guess: gameState.currentGuess, feedback: feedback });
            renderAttempt(gameState.currentGuess, feedback);


            // Sofortiger Sieg-Check: 9 korrekte Positionen
            if (correctCount === 9) {
                endGame(true);
                return;
            }

            // N√§chsten Versuch vorbereiten
            gameState.attemptCount++;
            gameState.currentGuess = Array(9).fill('E');
            renderCurrentGuessGrid();
            updateSubmitButtonState();

            // Spielende-Check
            if (gameState.attemptCount >= MAX_ATTEMPTS) {
                endGame(false);
            }
            
            // Nach jedem Versuch (nur im Daily-Modus) speichern
            if (gameState.mode === 'daily') {
                saveDailyAttempts(gameState.attempts, false);
            }
        }
        
        // --- Spielende-Funktion ---
        
        function endGame(won) {
            gameState.gameOver = true;
            submitButton.disabled = true;
            
            // Speichere das Endergebnis (nur im Daily-Modus)
            if (gameState.mode === 'daily') {
                saveDailyAttempts(gameState.attempts, won);
            }
            
            targetItemNameEl.textContent = gameState.targetItem.toUpperCase(); 
            modalTargetName.textContent = gameState.targetItem.toUpperCase();
            renderCorrectRecipe(gameState.targetRecipe, correctRecipeDisplay);

            if (won) {
                modalTitle.textContent = "GEWONNEN!";
                modalMessage.textContent = `HERZLICHEN GL√úCKWUNSCH! DU HAST DAS REZEPT F√úR DIE ${gameState.targetItem.toUpperCase()} IN ${gameState.attemptCount} VERSUCHEN ERRATEN.`;
                modalTitle.classList.remove('text-red-700');
                modalTitle.classList.add('text-green-700');
                
                // Audio-Fix: Behandeln von Wiedergabefehlern in eingeschr√§nkten Umgebungen
                if (craftSound) { 
                    craftSound.currentTime = 0; 
                    craftSound.play().catch(e => {
                        // Ignoriere typische Fehler in eingeschr√§nkten Umgebungen (wie iFrames)
                        if (e.name === 'NotAllowedError' || e.message.includes('The operation is not supported')) {
                            console.warn("WARNUNG: Audiowiedergabe blockiert oder wird in dieser Umgebung nicht unterst√ºtzt.");
                        } else {
                            console.error("Fehler beim Abspielen des Craft-Sounds:", e);
                        }
                    }); 
                }

            } else {
                modalTitle.textContent = "SPIEL VORBEI!";
                modalMessage.textContent = `SCHADE, DAS KORREKTE REZEPT F√úR DIE ${gameState.targetItem.toUpperCase()} WAR:`;
                modalTitle.classList.remove('text-green-700');
                modalTitle.classList.add('text-red-700');
            }

            modalOverlay.classList.remove('hidden');
        }
        
        // --- Startup ---
        window.onload = function() {
            // Hinweis: craft.mp3 muss vorhanden sein, um Fehler zu vermeiden, falls die Datei fehlt.
            craftSound = new Audio('craft.mp3'); 
            initFirebaseAndAuth();
        };

    </script>
</body>
</html>
