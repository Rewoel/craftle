<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft Craftle: T√§gliche Herausforderung</title>
    <!-- Favicon wird jetzt √ºber die hochgeladene Datei geladen -->
    <link rel="icon" type="image/png" href="favicon.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <style>
        /* --- Minecraft UI Basis Styling --- */
        body {
            font-family: 'Press Start 2P', 'Inter', sans-serif;
            background-color: #3c3c3c; 
            color: #1f1f1f; 
            display: flex;
            flex-direction: column; 
            align-items: center; 
            padding: 20px;
        }
        .container {
            max-width: 600px;
            width: 100%;
        }

        /* Styling f√ºr das Titelbild */
        .game-title-image {
            max-width: 100%; 
            height: auto; 
            display: block; 
            margin-bottom: 30px; 
            image-rendering: pixelated; 
            width: 512px; 
            height: 112px; 
            object-fit: contain; 
        }

        /* The Main Card (Inventory/Crafting Table Window) */
        .mc-window {
            background-color: #c6c6c6; 
            border: 2px solid #000;
            box-shadow: 2px 2px 0 0 #555, -2px -2px 0 0 #fff; 
            padding: 6px; 
            border-radius: 0; 
            position: relative;
        }

        /* --- Slot Styling (50x50) --- */
        .mc-slot {
            background-color: #8b8b8b; 
            width: 50px; 
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            border-radius: 0;
            user-select: none;
            transition: none;
            
            /* Sunken/Inner Border Effect */
            border: 1px solid transparent;
            box-shadow: 1px 1px 0 0 #000, -1px -1px 0 0 #fff;
            position: relative; 
            overflow: hidden;
        }
        
        .mc-slot img {
            width: 80%; 
            height: 80%;
            object-fit: contain;
            image-rendering: pixelated; 
            z-index: 10;
        }

        .mc-slot.empty {
            background-color: #8b8b8b;
        }

        /* --- Grid and Layout --- */
        .mc-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0px;
            width: 156px; 
            aspect-ratio: 1 / 1;
            padding: 1px;
        }

        /* --- STYLES F√úR DEN PFEIL-BEREICH (JETZT KLEINER) --- */
        .mc-arrow-container {
            display: flex;
            align-items: center; 
            justify-content: center;
            padding: 0 5px; 
        }
        .crafting-arrow-img {
            width: 75px; 
            height: 75px; 
            object-fit: contain;
            image-rendering: pixelated;
            display: block;
        }

        /* --- Feedback Colors --- */
        .feedback-green {
            background-color: #00aa00 !important; 
            box-shadow: 1px 1px 0 0 #005500, -1px -1px 0 0 #55ff55 !important;
        }
        .feedback-yellow {
            background-color: #ffaa00 !important; 
            box-shadow: 1px 1px 0 0 #aa5500, -1px -1px 0 0 #ffff55 !important;
        }
        .feedback-gray {
            background-color: #555555 !important; 
            box-shadow: 1px 1px 0 0 #000000, -1px -1px 0 0 #8b8b8b !important;
        }

        /* --- Material Picker (Inventory) --- */
        .mc-inventory-grid {
            grid-template-columns: repeat(auto-fit, minmax(50px, 1fr));
            gap: 4px;
            padding-top: 8px;
        }
        .material-button {
            padding: 0;
            box-shadow: none;
            height: 50px;
            width: 100%;
        }
        .material-active {
            box-shadow: inset 1px 1px 0 0 #000, inset -1px -1px 0 0 #fff;
            outline: none;
            background-color: #c6c6c6; 
        }
        .mc-slot.material-empty {
            background-color: #555555;
            color: #c6c6c6;
            font-size: 0.5rem; 
        }

        /* --- General UI Elements --- */
        .mc-title {
            font-size: 1rem;
            font-weight: bold;
            color: #3f3f3f;
            text-shadow: 1px 1px 0 #fff;
            padding-left: 5px;
            margin-bottom: 5px;
            font-size: 0.6rem; 
        }
        .mc-button {
            border: 2px solid #000;
            background-color: #8b8b8b;
            box-shadow: 1px 1px 0 0 #555, -1px -1px 0 0 #fff;
            color: #1f1f1f;
            font-weight: bold;
            padding: 8px;
            text-shadow: 1px 1px 0 #fff;
            image-rendering: pixelated;
            font-size: 0.6rem; 
        }
        .mc-button:hover:not(:disabled) {
            background-color: #9c9c9c;
        }
        .mc-button:active:not(:disabled) {
            box-shadow: inset 1px 1px 0 0 #000, inset -1px -1px 0 0 #fff;
            padding-top: 9px;
            padding-bottom: 7px;
        }
        .mc-button:disabled {
            background-color: #555555;
            color: #8b8b8b;
            cursor: not-allowed;
            text-shadow: none;
        }
        #targetItemName {
            font-size: 0.8rem; 
        }
        #instructions h2 {
            font-size: 0.7rem;
        }
        #instructions ul {
            font-size: 0.55rem;
        }
        #loadingOverlay {
            background-color: rgba(60, 60, 60, 0.9);
            color: #fff;
            font-size: 1rem;
            padding: 20px;
        }

        /* Styling f√ºr den Namensinput, im Minecraft-Stil */
        .mc-input {
            border: 2px solid #000;
            background-color: #555555;
            color: #fff;
            font-weight: bold;
            padding: 6px;
            box-shadow: inset 1px 1px 0 0 #000, inset -1px -1px 0 0 #fff;
            font-family: 'Press Start 2P', sans-serif;
            font-size: 0.6rem;
            outline: none;
        }
        .mc-input::placeholder {
            color: #8b8b8b;
        }

        /* NEU: Minecraft Head Styling f√ºr Rangliste und Input */
        .mc-head-icon {
            width: 24px;
            height: 24px;
            image-rendering: pixelated; /* F√ºr den Minecraft-Look */
            border: 2px solid #1f1f1f;
            border-radius: 0;
            box-shadow: 1px 1px 0 0 #000, -1px -1px 0 0 #fff; 
        }
        
        /* Fallback Placeholder (f√ºr den ersten Buchstaben) */
        .mc-head-placeholder {
            width: 32px;
            height: 32px;
            font-size: 1rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #8b8b8b; /* Slot-Hintergrund */
            color: #1f1f1f;
            border: 1px solid #000;
            box-shadow: 1px 1px 0 0 #000, -1px -1px 0 0 #fff;
            border-radius: 0;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <img src="titel.png" alt="Minecraft Craftle" class="game-title-image" width="512" height="112">

    <div class="container">
        <div id="loadingOverlay" class="mc-window text-center mb-4">
            Lade Spiel und verbinde mit Firebase...
        </div>

        <!-- HAUPT-SPIELANSICHT -->
        <div id="mainGameView">
            <div id="gameContainer" class="mc-window shadow-2xl hidden">
                
                <div class="mc-title mb-2 text-center text-base text-gray-700" id="modeTitle">
                    ‚Äî Craftle wird geladen ‚Äî
                </div>

                <div class="mc-title mb-4 text-center">
                    <span class="text-base text-gray-700">CRAFTING F√úR:</span> 
                    <span id="targetItemName" class="font-bold text-xl text-orange-700">???</span>
                </div>

                <div class="flex items-start justify-center mb-6" style="align-items: center;">
                    <div id="currentGuessGrid" class="mc-grid">
                        <!-- Crafting Grid -->
                    </div>

                    <div class="mc-arrow-container">
                        <img id="craftingArrow" src="Pfeil.png" alt="Crafting Arrow" class="crafting-arrow-img">
                    </div>

                    <div id="resultSlot" class="mc-slot">
                        <span id="resultContent" class="text-xl font-bold text-gray-400">?</span>
                    </div>
                </div>

                <div class="mc-title mt-4">MATERIALIEN (INVENTORY)</div>
                <div id="materialPicker" class="grid mc-inventory-grid">
                    <!-- Material Picker -->
                </div>

                <div class="flex flex-col space-y-4 mt-6">
                    <button id="submitButton" class="mc-button text-lg" disabled>
                        REZEPT PR√úFEN (0/6)
                    </button>
                </div>
                
                <div class="mc-title mt-6 text-xl">BISHERIGE VERSUCHE:</div>
                <div id="attemptsContainer" class="space-y-3 p-2 border border-gray-500 rounded-sm">
                    <!-- Attempt History -->
                </div>

                <div class="flex space-x-2 mt-4 justify-center">
                    <button id="randomGameButton" class="mc-button">
                        ZUF√ÑLLIGES SPIEL STARTEN
                    </button>
                    <button id="dailyGameButton" class="mc-button hidden">
                        ZUM T√ÑGLICHEN CRAFTLE
                    </button>
                    <button id="leaderboardButton" class="mc-button">
                        RANGLISTE ANZEIGEN
                    </button>
                </div>

            </div> 
            
            <div id="instructions" class="bg-gray-700 p-4 rounded-lg shadow-xl mt-6 text-white">
                <h2 class="font-bold mb-2">ANLEITUNG</h2>
                <ul class="list-disc list-inside space-y-1">
                    <li>W√ÑHLE UNTEN EIN MATERIAL (ODER "LEER") AUS UND PLATZIERE ES IN DAS 3X3-GITTER.</li>
                    <li>DU KANNST EIN REZEPT PR√úFEN, SOBALD DU **MINDESTENS EIN MATERIAL** PLATZIERT HAST.</li>
                    <li>**FEEDBACK**: GR√úN = MATERIAL & POSITION RICHTIG. GELB = MATERIAL RICHTIG, POSITION FALSCH. GRAU = MATERIAL NICHT IM REZEPT.</li>
                </ul>
            </div>
        </div>
        <!-- ENDE HAUPT-SPIELANSICHT -->
        
        <!-- RANGLISTEN CONTAINER (Standardm√§√üig versteckt) -->
        <div id="leaderboardContainer" class="mc-window shadow-2xl mt-6 hidden">
            <div class="mc-title mb-4 text-center text-lg text-gray-700">
                RANGLISTE HEUTE (<span id="leaderboardDate">Datum</span>)
            </div>

            <!-- NAME EINGABE BEREICH -->
            <div class="p-3 mb-4 bg-gray-500/50 rounded-sm">
                <p class="mc-title mb-2 text-center text-white text-xs">DEIN SPIELERNAME (max. 10 Zeichen)</p>
                <div class="flex space-x-2 items-center">
                    <!-- Spieler-Kopf-Icon f√ºr den aktuellen Benutzer (mit ID) -->
                    <img id="currentUserHead" src="" alt="Dein Kopf" class="mc-head-icon flex-shrink-0" style="width: 32px; height: 32px;">
                    <input type="text" id="displayNameInput" class="mc-input w-full" maxlength="10" placeholder="Max Mustermann">
                    <button id="saveDisplayNameButton" class="mc-button px-4 py-2 flex-shrink-0">
                        SPEICHERN
                    </button>
                </div>
                <p id="nameFeedback" class="text-center text-xs text-green-700 mt-1 hidden"></p>
                <p id="nameChangesRemainingEl" class="text-center text-xs text-white mt-2"></p>
            </div>
            <!-- ENDE NAME EINGABE BEREICH -->

            <div id="leaderboardList" class="space-y-2 text-xs">
                <!-- Leaderboard items will be rendered here -->
            </div>
            <p id="leaderboardLoading" class="text-center text-sm text-gray-600 mt-4">Lade Rangliste...</p>
            <p id="leaderboardError" class="text-center text-sm text-red-600 hidden mt-4">Fehler beim Laden der Rangliste.</p>

            <div class="flex justify-center mt-6">
                 <button id="backButton" class="mc-button py-2 px-6">
                    ‚Üê ZUR√úCK
                </button>
            </div>
        </div>
        <!-- ENDE RANGLISTEN CONTAINER -->


    </div>

    <!-- MODAL F√úR SPIELENDE -->
    <div id="modalOverlay" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div id="modalContent" class="mc-window p-8 w-11/12 max-w-md text-center border-4 border-black">
            <h3 id="modalTitle" class="text-3xl font-bold mb-4 text-orange-700 text-shadow-lg"></h3>
            <p id="modalMessage" class="mb-6 text-lg"></p>
            <div class="bg-gray-400 p-3 mb-6 border border-gray-500">
                <p class="text-sm font-semibold mb-2">DAS KORREKTE REZEPT F√úR: <span id="modalTargetName" class="font-bold"></span></p>
                <div id="correctRecipeDisplay" class="mc-grid mx-auto max-w-[156px]"></div>
            </div>
            
            <!-- NEU: Teilen-Button und Restart-Button -->
            <div class="flex justify-center space-x-4 mt-6">
                <button id="modalRestartButton" class="mc-button py-2 px-6">
                    NEUES SPIEL STARTEN
                </button>
                <button id="shareButton" class="mc-button py-2 px-6 bg-green-500 hover:bg-green-600 border-green-700 hidden">
                    TEILEN üì£
                </button>
            </div>
        </div>
    </div>


    <script type="module">
        // Importe f√ºr Firebase SDK v12.5.0. 'collection', 'query' und 'getDocs' hinzugef√ºgt.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp, collection, query, getDocs } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
        
        // --- üîí FIREBASE KONFIGURATION üîí ---
        // Dies ist die von Ihnen bereitgestellte Konfiguration.
        const YOUR_FIREBASE_CONFIG = {
            apiKey: "AIzaSyADgBthcev7lz4GpgqpUMfD5ehNAJXvHXE",
            authDomain: "craftle-ce3ce.firebaseapp.com",
            projectId: "craftle-ce3ce",
            storageBucket: "craftle-ce3ce.firebasestorage.app",
            messagingSenderId: "949644251377",
            appId: "1:949644251377:web:cb150ef2ea7a4ab1ac1950",
            measurementId: "G-QJS81B2GC1"
        };
        // ------------------------------------

        // Konstanten
        const MAX_ATTEMPTS = 6;
        const MAX_NAME_CHANGES = 3; 
        const CRAFTLE_APP_ID = YOUR_FIREBASE_CONFIG.projectId; 
        const DEFAULT_DISPLAY_NAME = "Anonymer Spieler"; // Fallback-Name
        
        // Konstanten f√ºr die Teilen-Funktion
        const EMOJI_GREEN = 'üü©';
        const EMOJI_YELLOW = 'üü®';
        const EMOJI_GRAY = '‚¨ú'; // Wei√ües Quadrat als Ersatz f√ºr Grau
        const GAME_URL = 'https://rewoel.github.io/craftle/';

        // Globale Variablen
        let gameState = {};
        let craftSound;
        let app, db, auth;
        let userId = null; 
        let currentDisplayName = DEFAULT_DISPLAY_NAME; // Speichert den geladenen Namen
        let nameChangesRemaining = MAX_NAME_CHANGES; // Verbleibende Namens√§nderungen


        
        // --- Material- und Rezepte-Daten (unver√§ndert) ---
        const materialMap = {
            'E': { name: 'Leer', fileName: 'Leer.png', size: '160x160', mcColor: '#8b8b8b' },
            'W': { name: 'Holz', fileName: 'Eichenholzbretter.png', size: '300x300', mcColor: '#a0522d' },
            'C': { name: 'Stein', fileName: 'Bruchstein.png', size: '300x300', mcColor: '#808080' },
            'I': { name: 'Eisen', fileName: 'Eisenbarren.png', size: '160x160', mcColor: '#c0c0c0' },
            'S': { name: 'Stock', fileName: 'Stock.png', size: '160x160', mcColor: '#7a5230' },
            'D': { name: 'Dia', fileName: 'Diamant.png', size: '160x160', mcColor: '#6afb92' },
            'G': { name: 'Gold', fileName: 'Goldbarren.png', size: '160x160', mcColor: '#ffd700' },
        };

        const recipes = [
            { item: 'Holzspitzhacke', recipe: ['W', 'W', 'W', 'E', 'S', 'E', 'E', 'S', 'E'] },
            { item: 'Truhe', recipe: ['W', 'W', 'W', 'W', 'E', 'W', 'W', 'W', 'W'] },
            { item: 'Ofen', recipe: ['C', 'C', 'C', 'C', 'E', 'C', 'C', 'C', 'C'] },
            { item: 'Fackel', recipe: ['E', 'E', 'E', 'E', 'C', 'E', 'E', 'S', 'E'] }, 
            { item: 'Eisenhelm', recipe: ['I', 'I', 'I', 'I', 'E', 'I', 'E', 'E', 'E'] },
            { item: 'Schwert', recipe: ['E', 'I', 'E', 'E', 'I', 'E', 'E', 'S', 'E'] },
            { item: 'Eimer', recipe: ['I', 'E', 'I', 'E', 'I', 'E', 'E', 'E', 'E'] },
            { item: 'Diamantblock', recipe: ['D', 'D', 'D', 'D', 'D', 'D', 'D', 'D', 'D'] },
        ];


        // --- DOM-Elemente ---
        const loadingOverlayEl = document.getElementById('loadingOverlay'); 
        const targetItemNameEl = document.getElementById('targetItemName');
        const currentGuessGridEl = document.getElementById('currentGuessGrid');
        const materialPickerEl = document.getElementById('materialPicker');
        const submitButton = document.getElementById('submitButton');
        const attemptsContainerEl = document.getElementById('attemptsContainer');
        const randomGameButton = document.getElementById('randomGameButton');
        const dailyGameButton = document.getElementById('dailyGameButton');
        const leaderboardButton = document.getElementById('leaderboardButton'); 
        const leaderboardContainerEl = document.getElementById('leaderboardContainer'); 
        const leaderboardListEl = document.getElementById('leaderboardList'); 
        const leaderboardLoadingEl = document.getElementById('leaderboardLoading'); 
        const leaderboardErrorEl = document.getElementById('leaderboardError'); 
        const modalOverlay = document.getElementById('modalOverlay');
        const modalRestartButton = document.getElementById('modalRestartButton');
        const shareButton = document.getElementById('shareButton'); // NEU
        const mainGameView = document.getElementById('mainGameView'); 
        const backButton = document.getElementById('backButton'); 
        const displayNameInput = document.getElementById('displayNameInput'); 
        const saveDisplayNameButton = document.getElementById('saveDisplayNameButton'); 
        const nameFeedback = document.getElementById('nameFeedback'); 
        const nameChangesRemainingEl = document.getElementById('nameChangesRemainingEl'); 
        const currentUserHeadEl = document.getElementById('currentUserHead'); 
        
        // --- Minecraft Head Generator & Fallback (MINOTAR) ---

        /**
         * Gibt die URL f√ºr den Minecraft-Kopf des Spielers zur√ºck (Minotar).
         * @param {string} displayName 
         * @returns {string} Bild-URL
         */
        function getMinecraftHeadUrl(displayName) {
            let username = displayName;

            if (displayName.startsWith('Spieler ') || displayName === DEFAULT_DISPLAY_NAME || displayName.length === 0) {
                username = 'Steve';
            }
            
            return `https://minotar.net/helm/${username}/32.png`;
        }
        
        /**
         * Gibt die URL f√ºr einen Platzhalter-Kopf zur√ºck (wenn Minecraft-Kopf fehlschl√§gt).
         * @param {string} displayName 
         * @returns {string} Bild-URL (placehold.co)
         */
        function getPlaceholderHeadUrl(displayName) {
            const firstLetter = displayName.charAt(0).toUpperCase() || '?';
            const bgColor = '8b8b8b'; 
            const fgColor = '1f1f1f'; 
            return `https://placehold.co/32x32/${bgColor}/${fgColor}?text=${firstLetter}`;
        }


        // --- Firebase Initialisierung und Auth ---

        async function initFirebaseAndAuth() {
            try {
                if (!YOUR_FIREBASE_CONFIG.projectId) {
                    throw new Error("Firebase Konfiguration fehlt.");
                }

                app = initializeApp(YOUR_FIREBASE_CONFIG);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Anonyme Anmeldung f√ºr jeden Besucher
                const userCredential = await signInAnonymously(auth);
                userId = userCredential.user.uid;

                console.log("Firebase initialized. User ID:", userId);
                
                // Lade den gespeicherten Namen und den Z√§hler f√ºr Namens√§nderungen, bevor das Spiel startet
                await loadDisplayName(); 
                
                loadingOverlayEl.classList.add('hidden');
                document.getElementById('gameContainer').classList.remove('hidden');

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                loadingOverlayEl.textContent = 'Fehler beim Laden (DB-Verbindung fehlgeschlagen). Starte zuf√§lliges Spiel.';
                
                // Fallback: Starte zuf√§lliges Spiel ohne DB
                await new Promise(resolve => setTimeout(resolve, 2000));
                loadingOverlayEl.classList.add('hidden');
                document.getElementById('gameContainer').classList.remove('hidden');
                startCraftle('random');
                return;
            }

            // Starte das Spiel im Daily-Modus, nachdem Firebase bereit ist
            startCraftle('daily');
        }

        // --- Firebase Lese- und Schreibfunktionen ---
        
        function getDateString() {
            // Holt das aktuelle Datum im Format YYYY-MM-DD
            return new Date().toISOString().split('T')[0];
        }
        
        async function checkIfUserHasScoreToday() {
            if (!userId) return false;
            const dateString = getDateString();
            // Public Path: /artifacts/{CRAFTLE_APP_ID}/public/data/daily_leaderboards/{YYYY-MM-DD}/scores/{userId}
            const docRef = doc(db, `artifacts/${CRAFTLE_APP_ID}/public/data/daily_leaderboards/${dateString}/scores`, userId);
            try {
                const docSnap = await getDoc(docRef);
                return docSnap.exists();
            } catch (error) {
                console.error("Error checking for user score:", error);
                return false;
            }
        }

        // Aktualisiert den UI-Status der Namens√§nderung
        async function updateNameChangeUI() {
            if (!displayNameInput || !nameChangesRemainingEl) return;
            
            // Setze den aktuellen Namen im Inputfeld
            displayNameInput.value = currentDisplayName.startsWith('Spieler') ? '' : currentDisplayName;
            displayNameInput.placeholder = currentDisplayName;
            
            // Setze das Minecraft Head Icon mit Fallback-Logik
            currentUserHeadEl.src = getMinecraftHeadUrl(currentDisplayName);
            currentUserHeadEl.onerror = function() {
                this.src = getPlaceholderHeadUrl(currentDisplayName);
                this.onerror = null; // Verhindert eine Endlosschleife
            };
            
            const hasScoreToday = await checkIfUserHasScoreToday();

            if (hasScoreToday) {
                nameChangesRemainingEl.textContent = `Verbleibende √Ñnderungen (bei Score-Update): ${nameChangesRemaining}/${MAX_NAME_CHANGES}`;
                
                if (nameChangesRemaining <= 0) {
                    displayNameInput.disabled = true;
                    saveDisplayNameButton.disabled = true;
                    nameChangesRemainingEl.classList.remove('text-white');
                    nameChangesRemainingEl.classList.add('text-red-500');
                } else {
                    displayNameInput.disabled = false;
                    saveDisplayNameButton.disabled = false;
                    nameChangesRemainingEl.classList.add('text-white');
                    nameChangesRemainingEl.classList.remove('text-red-500');
                }
            } else {
                // Wenn kein Score vorhanden ist, ist die √Ñnderung immer erlaubt und kostenlos (keine Begrenzung angezeigt)
                displayNameInput.disabled = false;
                saveDisplayNameButton.disabled = false;
                nameChangesRemainingEl.textContent = 'Namens√§nderung kostenlos, solange kein Score eingereicht wurde.';
                nameChangesRemainingEl.classList.remove('text-red-500');
                nameChangesRemainingEl.classList.add('text-white');
            }
        }


        // L√§dt den gespeicherten Anzeigenamen und den Z√§hler
        async function loadDisplayName() {
            if (!userId) return;
            
            // Pfad: /artifacts/{CRAFTLE_APP_ID}/users/{userId}/settings/profile
            const docRef = doc(db, `artifacts/${CRAFTLE_APP_ID}/users/${userId}/settings`, 'profile');
            
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // Lade Anzeigenamen
                    if (data.displayName && data.displayName.length > 0) {
                        currentDisplayName = data.displayName;
                    } else {
                        currentDisplayName = `Spieler ${userId.substring(0, 4)}`;
                    }
                    
                    // Lade verbleibende Namens√§nderungen
                    if (typeof data.leaderboardNameChangesRemaining === 'number') {
                        nameChangesRemaining = data.leaderboardNameChangesRemaining;
                    } else {
                        // Initialisiere den Z√§hler beim ersten Laden, falls er fehlt
                        nameChangesRemaining = MAX_NAME_CHANGES;
                    }
                    
                } else {
                    currentDisplayName = `Spieler ${userId.substring(0, 4)}`;
                    nameChangesRemaining = MAX_ATTEMPTS;
                }
            } catch (error) {
                console.warn("Could not load display name:", error);
            }
            
            // Aktualisiere UI nach dem Laden
            updateNameChangeUI();
        }
        
        // Speichert den Anzeigenamen des Benutzers
        async function saveDisplayName(newName) {
            if (!userId || !newName || newName.length === 0) return;
            
            const sanitizedName = newName.substring(0, 10);
            const oldDisplayName = currentDisplayName;
            
            // Verhindere Speichern, wenn der Name gleich ist
            if (sanitizedName === oldDisplayName) {
                nameFeedback.textContent = 'Name ist bereits gespeichert.';
                nameFeedback.classList.remove('hidden', 'text-green-700', 'text-red-700');
                nameFeedback.classList.add('text-gray-200');
                setTimeout(() => nameFeedback.classList.add('hidden'), 2000);
                return;
            }

            const hasScoreToday = await checkIfUserHasScoreToday();
            let changeAllowed = true;
            let decrementCounter = false;
            
            // 1. Wenn der Benutzer bereits einen Score eingereicht hat, gelten die Limits
            if (hasScoreToday) {
                if (nameChangesRemaining > 0) {
                    decrementCounter = true;
                } else {
                    changeAllowed = false;
                    nameFeedback.textContent = `FEHLER: Limit von ${MAX_NAME_CHANGES} Namens√§nderungen erreicht.`;
                    nameFeedback.classList.remove('hidden', 'text-green-700');
                    nameFeedback.classList.add('text-red-700');
                    return;
                }
            } 
            // 2. Wenn kein Score eingereicht wurde, ist die √Ñnderung immer erlaubt und kostenlos (kein Decrement)

            if (changeAllowed) {
                
                // 2a. Aktualisiere den privaten Profil-Dokument
                const profileDocRef = doc(db, `artifacts/${CRAFTLE_APP_ID}/users/${userId}/settings`, 'profile');
                const updateData = {
                    displayName: sanitizedName,
                    timestamp: serverTimestamp()
                };
                
                if (decrementCounter) {
                    nameChangesRemaining--;
                    updateData.leaderboardNameChangesRemaining = nameChangesRemaining;
                }

                try {
                    await setDoc(profileDocRef, updateData, { merge: true });
                    currentDisplayName = sanitizedName; // Globalen Status aktualisieren
                    
                    // 2b. Aktualisiere den √∂ffentlichen Leaderboard-Eintrag, falls vorhanden
                    if (hasScoreToday) {
                        const dateString = getDateString();
                        const leaderboardDocRef = doc(db, `artifacts/${CRAFTLE_APP_ID}/public/data/daily_leaderboards/${dateString}/scores`, userId);
                        await setDoc(leaderboardDocRef, { displayName: sanitizedName }, { merge: true });
                    }
                    
                    nameFeedback.textContent = `Gespeichert! ${decrementCounter ? `(Noch ${nameChangesRemaining} √Ñnderung(en) verf√ºgbar)` : ''}`;
                    nameFeedback.classList.remove('hidden', 'text-red-700');
                    nameFeedback.classList.add('text-green-700');
                    setTimeout(() => nameFeedback.classList.add('hidden'), 3000);
                    
                    updateNameChangeUI(); // UI-Status nach dem Speichern aktualisieren

                } catch (error) {
                    console.error("Error saving display name:", error);
                    nameFeedback.textContent = 'FEHLER: Fehler beim Speichern des Namens.';
                    nameFeedback.classList.remove('hidden', 'text-green-700');
                    nameFeedback.classList.add('text-red-700');
                    setTimeout(() => nameFeedback.classList.add('hidden'), 3000);
                }
            }
        }


        async function getDailyRecipeIndex() {
            const dateString = getDateString();
            // Pfad: /artifacts/{CRAFTLE_APP_ID}/public/data/daily_craftles/{YYYY-MM-DD}
            const docRef = doc(db, `artifacts/${CRAFTLE_APP_ID}/public/data/daily_craftles`, dateString);

            try {
                // 1. Leseversuch
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    return docSnap.data().recipeIndex;
                } else {
                    // 2. Erstelle ein neues t√§gliches Rezept, wenn es noch nicht existiert
                    const randomIndex = Math.floor(Math.random() * recipes.length);
                    
                    // 3. Speichern des neuen t√§glichen Rezepts
                    if(userId) {
                         await setDoc(docRef, { 
                            recipeIndex: randomIndex, 
                            timestamp: serverTimestamp()
                        }, { merge: true });
                    }
                   
                    return randomIndex;
                }
            } catch (error) {
                console.error("Error accessing/creating daily recipe in DB:", error);
                
                // Fallback auf zuf√§lliges Rezept, wenn DB-Zugriff fehlschl√§gt
                return Math.floor(Math.random() * recipes.length);
            }
        }
        
        async function saveDailyAttempts(attempts, won) {
            if (!userId) return; 
            
            const dateString = getDateString();
            // Pfad: /artifacts/{CRAFTLE_APP_ID}/users/{userId}/daily_progress/{YYYY-MM-DD}
            const docRef = doc(db, `artifacts/${CRAFTLE_APP_ID}/users/${userId}/daily_progress`, dateString);

            try {
                await setDoc(docRef, {
                    attempts: JSON.stringify(attempts), 
                    won: won,
                    timestamp: serverTimestamp()
                }, { merge: true });
            } catch (error) {
                console.error("Error saving daily progress:", error);
            }
        }
        
        async function loadDailyProgress() {
            if (!userId) return null;
            
            const dateString = getDateString();
            const docRef = doc(db, `artifacts/${CRAFTLE_APP_ID}/users/${userId}/daily_progress`, dateString);
            
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // Stelle sicher, dass 'attempts' existiert und geparst werden kann
                    return {
                        attempts: data.attempts ? JSON.parse(data.attempts) : [],
                        won: data.won || false
                    };
                }
            } catch (error) {
                console.warn("Could not load daily progress, starting fresh:", error);
            }
            return null;
        }

        // Speichert das Ergebnis im √∂ffentlichen Leaderboard
        async function saveLeaderboardResult(attempts) {
            if (!userId || gameState.mode !== 'daily' || !attempts || attempts.length === 0) return;
            
            const dateString = getDateString();
            // Public Path: /artifacts/{CRAFTLE_APP_ID}/public/data/daily_leaderboards/{YYYY-MM-DD}/scores/{userId}
            const docRef = doc(db, `artifacts/${CRAFTLE_APP_ID}/public/data/daily_leaderboards/${dateString}/scores`, userId);

            try {
                const score = attempts.length;

                // Pr√ºfen, ob bereits ein besserer Score existiert
                const docSnap = await getDoc(docRef);
                if (docSnap.exists() && docSnap.data().score <= score) {
                    console.log("Existing score is better or equal. Not updating leaderboard.");
                    return;
                }

                // Verwende den globalen currentDisplayName
                const displayNameForLeaderboard = currentDisplayName.length > 0 ? currentDisplayName : `Spieler ${userId.substring(0, 4)}`;

                // Speichern des neuen oder besseren Scores
                await setDoc(docRef, {
                    userId: userId,
                    score: score,
                    displayName: displayNameForLeaderboard, // Verwende den gespeicherten/aktuellen Namen
                    timestamp: serverTimestamp()
                }, { merge: true });
                
                console.log(`Leaderboard result saved: ${score} attempts for ${displayNameForLeaderboard}.`);

            } catch (error) {
                console.error("Error saving leaderboard result:", error);
            }
        }

        // --- Initialisierung des Spiels (Mode-abh√§ngig) ---
        async function startCraftle(mode = 'daily') {
            let target;
            let initialAttempts = [];
            let initialWon = false;
            
            hideLeaderboard(); // Stelle sicher, dass die Rangliste ausgeblendet ist.
            shareButton.classList.add('hidden'); // NEU: Share Button verstecken

            if (mode === 'daily') {
                document.getElementById('modeTitle').textContent = '‚Äî DAS CRAFTLE DES TAGES ‚Äî';
                const targetIndex = await getDailyRecipeIndex();
                target = recipes[targetIndex];
                
                const progress = await loadDailyProgress();
                if (progress) {
                    initialAttempts = progress.attempts;
                    initialWon = progress.won;
                    if (initialWon || initialAttempts.length >= MAX_ATTEMPTS) {
                        gameState.targetRecipe = target.recipe;
                        gameState.targetItem = target.item;
                        gameState.attempts = initialAttempts;
                        gameState.attemptCount = initialAttempts.length;
                        endGame(initialWon); 
                        
                        randomGameButton.classList.remove('hidden');
                        dailyGameButton.classList.add('hidden');
                        return;
                    }
                }
                
                randomGameButton.classList.remove('hidden');
                dailyGameButton.classList.add('hidden');
                
            } else {
                document.getElementById('modeTitle').textContent = '‚Äî ZUF√ÑLLIGES SPIEL ‚Äî';
                const randomIndex = Math.floor(Math.random() * recipes.length);
                target = recipes[randomIndex];
                randomGameButton.classList.add('hidden');
                dailyGameButton.classList.remove('hidden');
            }

            // Gemeinsame Initialisierung
            gameState = {
                targetRecipe: target.recipe,
                targetItem: target.item,
                currentGuess: Array(9).fill('E'),
                attempts: initialAttempts,
                attemptCount: initialAttempts.length,
                gameOver: false,
                selectedMaterial: 'W', 
                mode: mode,
            };

            targetItemNameEl.textContent = '???'; 
            submitButton.textContent = `REZEPT PR√úFEN (${gameState.attemptCount}/${MAX_ATTEMPTS})`;
            submitButton.disabled = gameState.gameOver;
            attemptsContainerEl.innerHTML = '';
            modalOverlay.classList.add('hidden');
            
            gameState.attempts.forEach(attempt => {
                renderAttempt(attempt.guess, attempt.feedback, true); // true = no animation
            });

            renderCurrentGuessGrid();
            renderMaterialPicker();
            updateSubmitButtonState();
        }

        // ... [Restliche Rendering Funktionen] ...
        
        function getMaterialImageUrl(materialId) {
            const material = materialMap[materialId];
            if (materialId === 'E') return ''; 
            const [width, height] = material.size.split('x');
            const color = material.mcColor.replace('#', '');
            const textColor = 'ffffff'; 
            return `https://placehold.co/${width}x${height}/${color}/${textColor}?text=${material.name.substring(0,3)}`;
        }

        function createMaterialImageElement(materialId) {
            const material = materialMap[materialId];
            const img = document.createElement('img');
            img.src = material.fileName;
            img.alt = material.name;
            
            img.onerror = function() {
                this.src = getMaterialImageUrl(materialId);
                this.onerror = null; 
            };
            
            img.classList.add('transition', 'duration-100', 'ease-out');
            return img;
        }


        function renderCurrentGuessGrid() {
            currentGuessGridEl.innerHTML = '';
            gameState.currentGuess.forEach((materialId, index) => {
                const slot = document.createElement('div');
                slot.className = `mc-slot`;
                slot.id = `slot-${index}`;
                
                if (materialId !== 'E') {
                    const img = createMaterialImageElement(materialId);
                    slot.appendChild(img);
                } else {
                    slot.classList.add('empty');
                }

                slot.addEventListener('click', () => handleSlotClick(index));
                currentGuessGridEl.appendChild(slot);
            });
        }


        function renderMaterialPicker() {
            materialPickerEl.innerHTML = '';
            const availableMaterials = Object.keys(materialMap);

            availableMaterials.forEach(id => {
                const material = materialMap[id];
                const button = document.createElement('button');
                
                if (id === 'E') {
                    button.className = `mc-slot material-button material-empty font-semibold ${gameState.selectedMaterial === id ? 'material-active' : ''}`;
                    button.textContent = 'LEER';
                } else {
                    button.className = `mc-slot material-button font-semibold ${gameState.selectedMaterial === id ? 'material-active' : ''}`;
                    const img = createMaterialImageElement(id);
                    button.appendChild(img);
                }

                button.setAttribute('data-material-id', id);

                button.addEventListener('click', () => {
                    gameState.selectedMaterial = id;
                    renderMaterialPicker(); 
                });
                materialPickerEl.appendChild(button);
            });
        }

        function renderAttempt(guess, feedback, noAnimation = false) {
            const attemptDiv = document.createElement('div');
            attemptDiv.className = 'flex flex-col p-2 bg-gray-500/50 rounded-sm feedback-grid';

            const feedbackGrid = document.createElement('div');
            feedbackGrid.className = 'mc-grid mx-auto';

            guess.forEach((materialId, index) => {
                const fb = feedback[index];
                const slot = document.createElement('div');
                
                slot.className = `mc-slot ${fb.color}`; 
                
                if (materialId !== 'E') {
                    const img = createMaterialImageElement(materialId);
                    slot.appendChild(img);
                } else {
                    slot.classList.add('empty');
                }
                
                if (!noAnimation) {
                    slot.style.animationDelay = `${index * 0.05}s`;
                }

                feedbackGrid.appendChild(slot);
            });

            attemptDiv.appendChild(feedbackGrid);
            attemptsContainerEl.prepend(attemptDiv);
        }

        function renderCorrectRecipe(recipe, containerEl) {
            containerEl.innerHTML = '';
            recipe.forEach(materialId => {
                const slot = document.createElement('div');
                slot.className = `mc-slot`;
                
                if (materialId !== 'E') {
                    const img = createMaterialImageElement(materialId);
                    slot.appendChild(img);
                    slot.style.boxShadow = `1px 1px 0 0 #fff, -1px -1px 0 0 #000`; 
                } else {
                    slot.classList.add('empty');
                }

                containerEl.appendChild(slot);
            });
        }
        
        // --- NEUE UI Umschaltfunktionen ---
        function showLeaderboardView() {
            mainGameView.classList.add('hidden');
            leaderboardContainerEl.classList.remove('hidden');
        }
        
        function hideLeaderboard() {
            mainGameView.classList.remove('hidden');
            leaderboardContainerEl.classList.add('hidden');
        }


        // Funktion zum Anzeigen/Laden der Rangliste
        async function showLeaderboard() {
            showLeaderboardView(); 
            
            // UI f√ºr Namens√§nderung aktualisieren (zeigt Z√§hler und Status an)
            await updateNameChangeUI(); 
            
            leaderboardListEl.innerHTML = '';
            leaderboardLoadingEl.classList.remove('hidden');
            leaderboardErrorEl.classList.add('hidden');
            
            const dateString = getDateString();
            document.getElementById('leaderboardDate').textContent = dateString;
            
            // Public Path: /artifacts/{CRAFTLE_APP_ID}/public/data/daily_leaderboards/{YYYY-MM-DD}/scores
            const collectionRef = collection(db, `artifacts/${CRAFTLE_APP_ID}/public/data/daily_leaderboards/${dateString}/scores`);
            
            try {
                const querySnapshot = await getDocs(collectionRef);
                const scores = [];

                querySnapshot.forEach((doc) => {
                    scores.push(doc.data());
                });

                scores.sort((a, b) => a.score - b.score);
                
                leaderboardLoadingEl.classList.add('hidden');
                
                if (scores.length === 0) {
                    leaderboardListEl.innerHTML = '<p class="text-center text-sm text-gray-700 p-2">Noch keine Eintr√§ge f√ºr heute. Sei der Erste, der gewinnt!</p>';
                    return;
                }

                // 2. Rendern der Liste
                scores.forEach((entry, index) => {
                    const isCurrentUser = entry.userId === userId;
                    const rank = index + 1;
                    const item = document.createElement('div');
                    item.className = `flex justify-between p-2 rounded-sm border-2 border-gray-600 ${isCurrentUser ? 'bg-yellow-300 shadow-lg text-black' : 'bg-gray-400'}`;
                    
                    const rankText = rank <= 3 ? (rank === 1 ? 'üèÜ' : (rank === 2 ? 'ü•à' : 'ü•â')) : `${rank}.`;
                    
                    // Name f√ºr die Anzeige: Entweder den gespeicherten Namen oder den Fallback
                    const displayedName = entry.displayName || `Spieler ${entry.userId.substring(0, 4)}`;
                    
                    // Hole die URL f√ºr den Kopf (jetzt Minotar)
                    const headUrl = getMinecraftHeadUrl(displayedName);
                    const placeholderUrl = getPlaceholderHeadUrl(displayedName);


                    // Verwenden von onerror im innerHTML, um den Fallback zu erm√∂glichen
                    item.innerHTML = `
                        <span class="font-bold w-1/6 text-left">${rankText}</span>
                        <span class="w-3/6 truncate font-semibold flex items-center space-x-2">
                            <!-- Minecraft Kopf-Icon mit Fallback -->
                            <img 
                                src="${headUrl}" 
                                alt="${displayedName} Kopf" 
                                class="mc-head-icon w-6 h-6 flex-shrink-0"
                                onerror="this.onerror=null; this.src='${placeholderUrl}';"
                            >
                            <span>${displayedName} ${isCurrentUser ? ' (DU)' : ''}</span>
                        </span>
                        <span class="font-bold w-2/6 text-right">${entry.score} Versuche</span>
                    `;
                    leaderboardListEl.appendChild(item);
                });

            } catch (error) {
                console.error("Error fetching leaderboard:", error);
                leaderboardLoadingEl.classList.add('hidden');
                leaderboardErrorEl.textContent = 'Fehler beim Laden: √úberpr√ºfe die Firestore-Regeln.';
                leaderboardErrorEl.classList.remove('hidden');
            }
        }
        
        // --- NEU: Teilen-Funktionen ---
        
        /**
         * Generiert die Textnachricht f√ºr das Teilen des Spielstands.
         * @returns {string} Die formatierte Nachricht.
         */
        function generateShareMessage() {
            const attempts = gameState.attempts;
            const scoreText = attempts.length <= MAX_ATTEMPTS ? `${attempts.length}/${MAX_ATTEMPTS}` : 'Verloren';
            const wonText = attempts.length <= MAX_ATTEMPTS ? 'Gel√∂st' : 'Nicht gel√∂st';
            
            let shareGrid = '';
            
            attempts.forEach(attempt => {
                let line = '';
                // Gehe durch die 9 Felder und ersetze Farben durch Emojis
                attempt.feedback.forEach(fb => {
                    if (fb.color === 'feedback-green') line += EMOJI_GREEN;
                    else if (fb.color === 'feedback-yellow') line += EMOJI_YELLOW;
                    else line += EMOJI_GRAY; 
                });
                shareGrid += line + '\n';
            });

            // Die finale Nachricht
            const message = `‚õèÔ∏è Minecraft Craftle des Tages (${getDateString()}): ${wonText} in ${scoreText} Versuchen!\n\n${shareGrid}\nSpiele jetzt selbst: ${GAME_URL}`;
            return message;
        }

        /**
         * Teilt den Spielstand √ºber die Web Share API oder als WhatsApp-Fallback.
         */
        function shareProgress() {
            const message = generateShareMessage();
            
            // 1. Web Share API (native Teilen-Funktion)
            if (navigator.share) {
                navigator.share({
                    title: 'Minecraft Craftle Score',
                    text: message,
                    url: GAME_URL 
                }).then(() => {
                    console.log('Progress shared successfully!');
                }).catch((error) => {
                    // Fehler ist oft nur, dass der Nutzer den Dialog abbricht
                    console.error('Error sharing (may be user cancelled):', error);
                });
            } else {
                // 2. WhatsApp URL Fallback
                const encodedMessage = encodeURIComponent(message);
                const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
                
                // √ñffnet den WhatsApp-Share-Dialog in einem neuen Tab/Fenster
                window.open(whatsappUrl, '_blank');
            }
        }
        
        // --- Event Handler und Logik ---

        function handleSlotClick(index) {
            if (gameState.gameOver) return;

            const currentMaterial = gameState.currentGuess[index];

            if (currentMaterial === gameState.selectedMaterial) {
                gameState.currentGuess[index] = 'E';
            } else {
                gameState.currentGuess[index] = gameState.selectedMaterial;
            }

            renderCurrentGuessGrid();
            updateSubmitButtonState();
        }

        function updateSubmitButtonState() {
            const isAnyMaterialPlaced = gameState.currentGuess.some(id => id !== 'E');
            submitButton.disabled = gameState.gameOver;
            submitButton.textContent = `REZEPT PR√úFEN (${gameState.attemptCount}/${MAX_ATTEMPTS})`;
        }

        submitButton.addEventListener('click', checkRecipe);
        randomGameButton.addEventListener('click', () => startCraftle('random'));
        dailyGameButton.addEventListener('click', () => startCraftle('daily'));
        leaderboardButton.addEventListener('click', showLeaderboard);
        backButton.addEventListener('click', hideLeaderboard); 
        
        saveDisplayNameButton.addEventListener('click', () => { 
            saveDisplayName(displayNameInput.value.trim());
        });
        
        // Nach Spielende (auch Daily) soll der Restart-Button immer ein frisches ZUF√ÑLLIGES Spiel starten.
        modalRestartButton.addEventListener('click', () => {
             startCraftle('random');
        });
        
        // NEU: Event Listener f√ºr den Share Button
        shareButton.addEventListener('click', shareProgress);


        function checkRecipe() {
            if (gameState.gameOver || submitButton.disabled) return;

            const guess = [...gameState.currentGuess];
            const target = [...gameState.targetRecipe];
            const feedback = Array(9).fill(null);
            
            // 1. GR√úN (Perfekter Treffer) pr√ºfen
            let correctCount = 0;
            for (let i = 0; i < 9; i++) {
                if (guess[i] === target[i]) { 
                    feedback[i] = { color: 'feedback-green', id: guess[i] };
                    correctCount++;
                    guess[i] = null; 
                    target[i] = null;
                }
            }
            
            // 2. GELB (Material im Rezept, aber falsche Position) pr√ºfen
            const targetCounts = {};
            for (let i = 0; i < 9; i++) {
                if (target[i] !== null && target[i] !== 'E') {
                    targetCounts[target[i]] = (targetCounts[target[i]] || 0) + 1;
                }
            }
            
            for (let i = 0; i < 9; i++) {
                if (feedback[i] === null && guess[i] !== null) {
                    const materialId = guess[i];
                    
                    if (materialId !== 'E' && targetCounts[materialId] > 0) {
                        feedback[i] = { color: 'feedback-yellow', id: materialId };
                        targetCounts[materialId]--;
                    } else {
                        feedback[i] = { color: 'feedback-gray', id: materialId };
                    }
                }
            }

            gameState.attempts.push({ guess: gameState.currentGuess, feedback: feedback });
            renderAttempt(gameState.currentGuess, feedback);


            // Sofortiger Sieg-Check: 9 korrekte Positionen
            if (correctCount === 9) {
                endGame(true);
                return;
            }

            // N√§chsten Versuch vorbereiten
            gameState.attemptCount++;
            gameState.currentGuess = Array(9).fill('E');
            renderCurrentGuessGrid();
            updateSubmitButtonState();

            // Spielende-Check
            if (gameState.attemptCount >= MAX_ATTEMPTS) {
                endGame(false);
            }
            
            // Nach jedem Versuch (nur im Daily-Modus) speichern
            if (gameState.mode === 'daily') {
                saveDailyAttempts(gameState.attempts, false);
            }
        }
        
        // --- Spielende-Funktion ---
        
        function endGame(won) {
            gameState.gameOver = true;
            submitButton.disabled = true;
            
            // NEU: Share Button Logic
            if (gameState.mode === 'daily' && won) {
                shareButton.classList.remove('hidden');
                // Optisches Styling f√ºr den Share Button
                shareButton.style.backgroundColor = '#4CAF50'; // Gr√ºn
                shareButton.style.boxShadow = '1px 1px 0 0 #388E3C, -1px -1px 0 0 #81C784';
            } else {
                shareButton.classList.add('hidden');
                shareButton.style.backgroundColor = '#8b8b8b';
            }
            
            // Speichere das Endergebnis (nur im Daily-Modus)
            if (gameState.mode === 'daily') {
                saveDailyAttempts(gameState.attempts, won);
                if (won) {
                    // Speichere den Score im Leaderboard
                    saveLeaderboardResult(gameState.attempts);
                }
            }
            
            targetItemNameEl.textContent = gameState.targetItem.toUpperCase(); 
            document.getElementById('modalTitle').textContent = won ? "GEWONNEN!" : "SPIEL VORBEI!";
            document.getElementById('modalMessage').textContent = won 
                ? `HERZLICHEN GL√úCKWUNSCH! DU HAST DAS REZEPT F√úR DIE ${gameState.targetItem.toUpperCase()} IN ${gameState.attemptCount} VERSUCHEN ERRATEN. Jetzt teilen!`
                : `SCHADE, DAS KORREKTE REZEPT F√úR DIE ${gameState.targetItem.toUpperCase()} WAR:`;

            document.getElementById('modalTargetName').textContent = gameState.targetItem.toUpperCase();
            renderCorrectRecipe(gameState.targetRecipe, correctRecipeDisplay);

            const modalTitleEl = document.getElementById('modalTitle');
            if (won) {
                modalTitleEl.classList.remove('text-red-700');
                modalTitleEl.classList.add('text-green-700');
            } else {
                modalTitleEl.classList.remove('text-green-700');
                modalTitleEl.classList.add('text-red-700');
            }

            if (craftSound) { 
                craftSound.currentTime = 0; 
                craftSound.play().catch(e => {
                    if (e.name === 'NotAllowedError' || e.message.includes('The operation is not supported')) {
                        console.warn("WARNUNG: Audiowiedergabe blockiert.");
                    } else {
                        console.error("Fehler beim Abspielen des Craft-Sounds:", e);
                    }
                }); 
            }

            modalOverlay.classList.remove('hidden');
        }
        
        // --- Startup ---
        window.onload = function() {
            // Hinweis: craft.mp3 muss vorhanden sein, um Fehler zu vermeiden, falls die Datei fehlt.
            craftSound = new Audio('craft.mp3'); 
            initFirebaseAndAuth();
        };

    </script>
</body>
</html>
